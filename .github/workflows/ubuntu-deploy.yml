name: Deploy Ubuntu

on:
  push:
    branches:
      - master
      - main
      - develop

  pull_request:
    branches:
      - master
      - main
      - develop

  workflow_dispatch:

#  schedule:
#    - cron: '0 0 * * 0'

jobs:

deploy:
  name: Deploy
  needs: build-test-drop-artifacts
  runs-on: ubuntu-latest
  environment: dev
  
  steps:
    - name: Fetch Sources
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Download Artifact
      uses: actions/download-artifact@v6
      with:
        name: version
        path: './'

    - name: 'Configure SSH'
      run: |
        mkdir -p ~/.ssh/
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        cat >>~/.ssh/config <<END
        Host staging
          HostName $SSH_ADDRESS
          User $SSH_USER
          IdentityFile ~/.ssh/id_rsa
          StrictHostKeyChecking no
        END
      env:
        SSH_KEY: ${{ secrets.UBUNTU_SSH_KEY }}
        SSH_USER: ${{ secrets.UBUNTU_SSH_USER }}
        SSH_ADDRESS: ${{ secrets.UBUNTU_SSH_ADDRESS }}

    - name: 'Test SSH'
      run: ssh staging -v "hostname"

    - name: 'List directory'
      run: |
        ls -lsa
        cat version.txt

    - name: 'Update compose version'
      shell: bash
      run: |
        VERSION=$(cat version.txt)
        echo "Version: $VERSION"
        chmod u+x ./scripts/sed_docker_compose.sh
        ./scripts/sed_docker_compose.sh "./prod-compose/docker-compose.yml" "$VERSION"

    - name: 'Copy compose to VM'
      shell: bash
      run: |
        chmod 600 ~/.ssh/id_rsa
        scp -r -i "~/.ssh/id_rsa" "./prod-compose/docker-compose.yml" \
          $SSH_USER@$SSH_ADDRESS:/home/$SSH_USER/ComposeCopyTest/docker-compose.yml
      env:
        SSH_KEY: ${{ secrets.UBUNTU_SSH_KEY }}
        SSH_USER: ${{ secrets.UBUNTU_SSH_USER }}
        SSH_ADDRESS: ${{ secrets.UBUNTU_SSH_ADDRESS }}

    - name: 'Deploy compose'
      shell: bash
      run: |
        echo "Stop service"
        ssh staging "sudo systemctl stop moviesapi.service"
        sleep 10
        echo "Copy compose"
        ssh staging "cp ~/ComposeCopyTest/docker-compose.yml ~/RiderProjects/MoviesAPI/docker-compose.yml"
        ssh staging "cd ~/RiderProjects/MoviesAPI && sudo docker-compose build"
        ssh staging "sudo systemctl start moviesapi.service"
      env:
        SSH_USER: ${{ secrets.UBUNTU_SSH_USER }}
        SSH_ADDRESS: ${{ secrets.UBUNTU_SSH_ADDRESS }}